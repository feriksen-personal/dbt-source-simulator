dataContractSpecification: 0.9.2
id: jaffle_shop_payments
info:
  title: Jaffle Shop Payments
  version: 1.0.0
  description: |
    Payment records from the jaffle_shop ERP system.

    **Deterministic Evolution:**
    - Baseline state: 0 payments (empty table)
    - Day 1 delta: +52 payments (IDs 1-52)
    - Day 2 delta: +44 payments (IDs 53-96)
    - Day 3 delta: +58 payments (IDs 97-154)

    **Patterns:**
    - Append-only event stream (new payments only)
    - Table starts empty at baseline
    - One payment per order (1:1 relationship)
    - Payment methods: credit_card, debit_card, gift_card
    - No updates or soft deletes
  owner: ERP System Team
  contact:
    name: Data Platform Team
    email: data-platform@example.com

servers:
  duckdb:
    type: duckdb
    location: data/ingestion_simulator.duckdb
    schema: jaffle_shop
    table: payments
  databricks:
    type: databricks
    host: ${DATABRICKS_SERVER_HOSTNAME}
    catalog: ${DATABRICKS_CATALOG}
    schema: erp
    table: payments

models:
  payments:
    description: Payment records linked to orders
    type: table
    fields:
      payment_id:
        type: integer
        required: true
        unique: true
        primary: true
        description: Unique payment identifier

      order_id:
        type: integer
        required: true
        unique: true
        description: Foreign key to orders table (one payment per order)
        references: orders.order_id

      payment_method:
        type: varchar
        required: true
        description: Payment method used
        enum:
          - credit_card
          - debit_card
          - gift_card
        example: "credit_card"

      amount:
        type: decimal
        required: true
        description: Payment amount in USD
        precision: 10
        scale: 2
        minValue: 0.00
        example: "25.47"

      payment_date:
        type: timestamp
        required: true
        description: Payment transaction timestamp

      created_at:
        type: timestamp
        required: true
        description: Record creation timestamp

      updated_at:
        type: timestamp
        required: true
        description: Record last update timestamp (rarely changes for append-only)

      deleted_at:
        type: timestamp
        required: false
        description: Soft delete timestamp (rarely used for immutable payments)

quality:
  type: SodaCL
  specification: |
    checks for payments:
      # Row count validation (append-only, starts at 0)
      - row_count >= 0

      # Primary key validation (when data exists)
      - missing_count(payment_id) = 0
      - duplicate_count(payment_id) = 0

      # Foreign key validation
      - duplicate_count(order_id) = 0  # One payment per order

      # Required fields (when data exists)
      - missing_count(order_id) = 0
      - missing_count(payment_method) = 0
      - missing_count(amount) = 0
      - missing_count(payment_date) = 0
      - missing_count(created_at) = 0
      - missing_count(updated_at) = 0

      # Payment method validation
      - invalid_count(payment_method) = 0:
          valid values: ['credit_card', 'debit_card', 'gift_card']

      # Business rule validation
      - min(amount) >= 0.00

      # No soft deletes (append-only)
      - missing_percent(deleted_at) = 100

      # Validate payment amount matches order total
      - schema:
          fail:
            when wrong column type:
              amount: decimal

examples:
  - type: csv
    model: payments
    description: Day 1 delta state (first payments added)
    data: |
      payment_id,order_id,payment_method,amount,payment_date,created_at,updated_at,deleted_at
      1,6,credit_card,15.98,2024-01-16 09:30:00,2024-01-16 09:30:00,2024-01-16 09:30:00,
      2,7,debit_card,25.47,2024-01-16 11:00:00,2024-01-16 11:00:00,2024-01-16 11:00:00,
      3,8,credit_card,12.99,2024-01-16 14:15:00,2024-01-16 14:15:00,2024-01-16 14:15:00,

tags:
  - source-system
  - erp
  - jaffle-shop
  - payments
  - deterministic
  - append-only
  - empty-baseline
