name: Generate Schema Diagrams

on:
  push:
    paths:
      - 'data/duckdb/baseline/*.sql'
      - 'data/azure/baseline/*.sql'
      - 'scripts/sql_to_dbml.py'
    branches:
      - main
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write  # Needed to push to wiki repository

jobs:
  generate-diagrams:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          pip install requests

      - name: Create output directories
        run: |
          mkdir -p docs/generated
          mkdir -p wiki/images

      - name: Generate DBML from SQL
        run: |
          python3 scripts/sql_to_dbml.py data/duckdb/baseline/shop_schema.sql > docs/generated/jaffle-shop.dbml
          python3 scripts/sql_to_dbml.py data/duckdb/baseline/crm_schema.sql > docs/generated/jaffle-crm.dbml

      - name: Generate ERD images from DBML
        run: |
          # Generate PNG diagrams using dbdiagram.io API
          # DBML files are temporary - not committed to main repo
          python3 scripts/dbml_to_png.py docs/generated/jaffle-shop.dbml wiki/images/jaffle-shop-erd.png
          python3 scripts/dbml_to_png.py docs/generated/jaffle-crm.dbml wiki/images/jaffle-crm-erd.png

      - name: Clone wiki repository
        run: |
          git clone https://github.com/${{ github.repository }}.wiki.git wiki-repo

      - name: Copy ERD images to wiki
        run: |
          mkdir -p wiki-repo/images
          cp wiki/images/jaffle-shop-erd.png wiki-repo/images/
          cp wiki/images/jaffle-crm-erd.png wiki-repo/images/

      - name: Commit and push to wiki
        run: |
          cd wiki-repo

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add images/*.png

          if git diff --cached --quiet; then
            echo "No wiki changes to commit"
          else
            git commit -m "docs: update ERD diagrams from SQL schemas"
            git push
          fi
