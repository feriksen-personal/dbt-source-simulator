name: Validate Data Quality (Soda + ODCS)

on:
  pull_request:
    branches: [main]
    paths:
      - 'extras/data_quality/**'
      - 'macros/**'
      - 'data/**'
      - '.github/workflows/validate-data-quality.yml'
  push:
    branches: [main]
    paths:
      - 'extras/data_quality/**'
  workflow_dispatch:

jobs:
  validate-soda-duckdb:
    name: Validate Soda Contracts & Scans (DuckDB)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dbt-duckdb
        run: pip install dbt-core dbt-duckdb

      - name: Install Soda Core
        run: pip install soda-core-duckdb

      - name: Set up dbt profile
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml <<EOF
          demo_source:
            target: dev
            outputs:
              dev:
                type: duckdb
                path: 'data/demo_source.duckdb'
          EOF

      - name: Install dbt dependencies
        run: dbt deps --profile demo_source

      - name: Load baseline data
        run: dbt run-operation demo_load_baseline --profile demo_source

      - name: Validate Soda contracts - jaffle_shop
        run: |
          soda scan -d demo_source \
            -c extras/data_quality/soda/configuration.yml \
            extras/data_quality/soda/contracts/jaffle_shop.yml

      - name: Validate Soda contracts - jaffle_crm
        run: |
          soda scan -d demo_source \
            -c extras/data_quality/soda/configuration.yml \
            extras/data_quality/soda/contracts/jaffle_crm.yml

      - name: Validate Soda scan - baseline checks
        run: |
          soda scan -d demo_source \
            -c extras/data_quality/soda/configuration.yml \
            extras/data_quality/soda/scans/baseline_checks.yml

      - name: Validate Soda scan - relationship checks
        run: |
          soda scan -d demo_source \
            -c extras/data_quality/soda/configuration.yml \
            extras/data_quality/soda/scans/relationship_checks.yml

      - name: Apply Day 1 delta
        run: "dbt run-operation demo_apply_delta --args '{day: 1}' --profile demo_source"

      - name: Validate Soda scan - Day 1 delta checks
        run: |
          soda scan -d demo_source \
            -c extras/data_quality/soda/configuration.yml \
            extras/data_quality/soda/scans/delta_day1_checks.yml

      - name: Validate Soda scan - relationships after Day 1
        run: |
          soda scan -d demo_source \
            -c extras/data_quality/soda/configuration.yml \
            extras/data_quality/soda/scans/relationship_checks.yml

      - name: Apply Day 2 delta
        run: "dbt run-operation demo_apply_delta --args '{day: 2}' --profile demo_source"

      - name: Validate Soda scan - Day 2 delta checks
        run: |
          soda scan -d demo_source \
            -c extras/data_quality/soda/configuration.yml \
            extras/data_quality/soda/scans/delta_day2_checks.yml

      - name: Validate Soda scan - relationships after Day 2
        run: |
          soda scan -d demo_source \
            -c extras/data_quality/soda/configuration.yml \
            extras/data_quality/soda/scans/relationship_checks.yml

      - name: Apply Day 3 delta
        run: "dbt run-operation demo_apply_delta --args '{day: 3}' --profile demo_source"

      - name: Validate Soda scan - Day 3 delta checks
        run: |
          soda scan -d demo_source \
            -c extras/data_quality/soda/configuration.yml \
            extras/data_quality/soda/scans/delta_day3_checks.yml

      - name: Validate Soda scan - relationships after Day 3
        run: |
          soda scan -d demo_source \
            -c extras/data_quality/soda/configuration.yml \
            extras/data_quality/soda/scans/relationship_checks.yml

  validate-soda-databricks:
    name: Validate Soda Contracts & Scans (Databricks)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    # Only run on manual dispatch or main branch to avoid using Databricks resources on every PR

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dbt-databricks
        run: pip install dbt-core dbt-databricks

      - name: Install Soda Core
        run: pip install soda-core-databricks

      - name: Set up environment variables
        env:
          DATABRICKS_SERVER_HOSTNAME: ${{ secrets.DATABRICKS_SERVER_HOSTNAME }}
          DATABRICKS_HTTP_PATH: ${{ secrets.DATABRICKS_HTTP_PATH }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
          DATABRICKS_CATALOG: ${{ secrets.DATABRICKS_CATALOG }}
        run: |
          echo "DATABRICKS_SERVER_HOSTNAME=${DATABRICKS_SERVER_HOSTNAME}" >> $GITHUB_ENV
          echo "DATABRICKS_HTTP_PATH=${DATABRICKS_HTTP_PATH}" >> $GITHUB_ENV
          echo "DATABRICKS_TOKEN=${DATABRICKS_TOKEN}" >> $GITHUB_ENV
          echo "DATABRICKS_CATALOG=${DATABRICKS_CATALOG}" >> $GITHUB_ENV

      - name: Install dbt dependencies
        run: dbt deps --profile demo_source

      - name: Test Databricks connection
        run: dbt debug --profile demo_source --target databricks

      - name: Load baseline data
        run: dbt run-operation demo_load_baseline --profile demo_source --target databricks

      - name: Validate Soda contracts - jaffle_shop
        run: |
          soda scan -d demo_source \
            -c extras/data_quality/soda/configuration.yml \
            extras/data_quality/soda/contracts/jaffle_shop.yml

      - name: Validate Soda contracts - jaffle_crm
        run: |
          soda scan -d demo_source \
            -c extras/data_quality/soda/configuration.yml \
            extras/data_quality/soda/contracts/jaffle_crm.yml

      - name: Validate Soda scan - baseline checks
        run: |
          soda scan -d demo_source \
            -c extras/data_quality/soda/configuration.yml \
            extras/data_quality/soda/scans/baseline_checks.yml

      - name: Apply Day 1 delta
        run: "dbt run-operation demo_apply_delta --args '{day: 1}' --profile demo_source --target databricks"

      - name: Validate Soda scan - Day 1 delta checks
        run: |
          soda scan -d demo_source \
            -c extras/data_quality/soda/configuration.yml \
            extras/data_quality/soda/scans/delta_day1_checks.yml

      - name: Validate Soda scan - relationships after Day 1
        run: |
          soda scan -d demo_source \
            -c extras/data_quality/soda/configuration.yml \
            extras/data_quality/soda/scans/relationship_checks.yml

      - name: Apply Day 2 delta
        run: "dbt run-operation demo_apply_delta --args '{day: 2}' --profile demo_source --target databricks"

      - name: Validate Soda scan - Day 2 delta checks
        run: |
          soda scan -d demo_source \
            -c extras/data_quality/soda/configuration.yml \
            extras/data_quality/soda/scans/delta_day2_checks.yml

      - name: Validate Soda scan - relationships after Day 2
        run: |
          soda scan -d demo_source \
            -c extras/data_quality/soda/configuration.yml \
            extras/data_quality/soda/scans/relationship_checks.yml

      - name: Apply Day 3 delta
        run: "dbt run-operation demo_apply_delta --args '{day: 3}' --profile demo_source --target databricks"

      - name: Validate Soda scan - Day 3 delta checks
        run: |
          soda scan -d demo_source \
            -c extras/data_quality/soda/configuration.yml \
            extras/data_quality/soda/scans/delta_day3_checks.yml

      - name: Validate Soda scan - relationships after Day 3
        run: |
          soda scan -d demo_source \
            -c extras/data_quality/soda/configuration.yml \
            extras/data_quality/soda/scans/relationship_checks.yml

      - name: Tag validated tables in Databricks
        if: success()
        run: |
          # Tag tables with soda:validated (ODCS tagging will be added once contracts are fixed)
          python3 -c "
          from databricks import sql
          import os

          with sql.connect(
            server_hostname=os.environ['DATABRICKS_SERVER_HOSTNAME'],
            http_path=os.environ['DATABRICKS_HTTP_PATH'],
            access_token=os.environ['DATABRICKS_TOKEN']
          ) as connection:
            with connection.cursor() as cursor:
              # Tag jaffle_shop tables
              for table in ['customers', 'products', 'orders', 'order_items', 'payments']:
                cursor.execute(f\"ALTER TABLE ${os.environ['DATABRICKS_CATALOG']}.jaffle_shop.{table} SET TAGS ('soda' = 'validated')\")

              # Tag jaffle_crm tables
              for table in ['campaigns', 'email_activity', 'web_sessions']:
                cursor.execute(f\"ALTER TABLE ${os.environ['DATABRICKS_CATALOG']}.jaffle_crm.{table} SET TAGS ('soda' = 'validated')\")
          "

      - name: Tag failed tables in Databricks
        if: failure()
        run: |
          # Tag tables with soda:invalid if validation failed (ODCS tagging will be added once contracts are fixed)
          python3 -c "
          from databricks import sql
          import os

          with sql.connect(
            server_hostname=os.environ['DATABRICKS_SERVER_HOSTNAME'],
            http_path=os.environ['DATABRICKS_HTTP_PATH'],
            access_token=os.environ['DATABRICKS_TOKEN']
          ) as connection:
            with connection.cursor() as cursor:
              # Tag jaffle_shop tables
              for table in ['customers', 'products', 'orders', 'order_items', 'payments']:
                cursor.execute(f\"ALTER TABLE ${os.environ['DATABRICKS_CATALOG']}.jaffle_shop.{table} SET TAGS ('soda' = 'invalid')\")

              # Tag jaffle_crm tables
              for table in ['campaigns', 'email_activity', 'web_sessions']:
                cursor.execute(f\"ALTER TABLE ${os.environ['DATABRICKS_CATALOG']}.jaffle_crm.{table} SET TAGS ('soda' = 'invalid')\")
          "

      - name: Cleanup - Reset to baseline
        if: always()
        run: dbt run-operation demo_reset --profile demo_source --target databricks

  validate-odcs-contracts:
    name: Validate ODCS Contracts (datacontract-cli)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dbt-duckdb
        run: pip install dbt-core dbt-duckdb

      - name: Install datacontract-cli
        run: pip install datacontract-cli

      - name: Set up dbt profile
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml <<EOF
          demo_source:
            target: dev
            outputs:
              dev:
                type: duckdb
                path: 'data/demo_source.duckdb'
          EOF

      - name: Install dbt dependencies
        run: dbt deps --profile demo_source

      - name: Load baseline data
        run: dbt run-operation demo_load_baseline --profile demo_source

      # Validate jaffle_shop contracts
      - name: Validate ODCS contract - jaffle_shop.customers
        run: datacontract test extras/data_quality/bitol/contracts/jaffle_shop_customers.yml

      - name: Validate ODCS contract - jaffle_shop.products
        run: datacontract test extras/data_quality/bitol/contracts/jaffle_shop_products.yml

      - name: Validate ODCS contract - jaffle_shop.orders
        run: datacontract test extras/data_quality/bitol/contracts/jaffle_shop_orders.yml

      - name: Validate ODCS contract - jaffle_shop.order_items
        run: datacontract test extras/data_quality/bitol/contracts/jaffle_shop_order_items.yml

      - name: Validate ODCS contract - jaffle_shop.payments
        run: datacontract test extras/data_quality/bitol/contracts/jaffle_shop_payments.yml

      # Validate jaffle_crm contracts
      - name: Validate ODCS contract - jaffle_crm.campaigns
        run: datacontract test extras/data_quality/bitol/contracts/jaffle_crm_campaigns.yml

      - name: Validate ODCS contract - jaffle_crm.email_activity
        run: datacontract test extras/data_quality/bitol/contracts/jaffle_crm_email_activity.yml

      - name: Validate ODCS contract - jaffle_crm.web_sessions
        run: datacontract test extras/data_quality/bitol/contracts/jaffle_crm_web_sessions.yml

      # Generate documentation from contracts
      - name: Generate ODCS contract documentation
        if: always()
        run: |
          mkdir -p contract-docs

          # Generate HTML documentation for each contract
          datacontract export extras/data_quality/bitol/contracts/jaffle_shop_customers.yml \
            --format html > contract-docs/jaffle_shop_customers.html

          datacontract export extras/data_quality/bitol/contracts/jaffle_shop_products.yml \
            --format html > contract-docs/jaffle_shop_products.html

          datacontract export extras/data_quality/bitol/contracts/jaffle_shop_orders.yml \
            --format html > contract-docs/jaffle_shop_orders.html

          datacontract export extras/data_quality/bitol/contracts/jaffle_shop_order_items.yml \
            --format html > contract-docs/jaffle_shop_order_items.html

          datacontract export extras/data_quality/bitol/contracts/jaffle_shop_payments.yml \
            --format html > contract-docs/jaffle_shop_payments.html

          datacontract export extras/data_quality/bitol/contracts/jaffle_crm_campaigns.yml \
            --format html > contract-docs/jaffle_crm_campaigns.html

          datacontract export extras/data_quality/bitol/contracts/jaffle_crm_email_activity.yml \
            --format html > contract-docs/jaffle_crm_email_activity.html

          datacontract export extras/data_quality/bitol/contracts/jaffle_crm_web_sessions.yml \
            --format html > contract-docs/jaffle_crm_web_sessions.html

      - name: Upload ODCS contract documentation
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: odcs-contract-docs
          path: contract-docs/
          retention-days: 30

  summary:
    name: Data Quality Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-soda-duckdb, validate-odcs-contracts]
    if: always()

    steps:
      - name: Check validation results
        run: |
          echo "## Data Quality Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Soda Contracts & Scans (DuckDB) | ${{ needs.validate-soda-duckdb.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ODCS Contracts (datacontract-cli) | ${{ needs.validate-odcs-contracts.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.validate-soda-duckdb.result }}" == "success" ]] && [[ "${{ needs.validate-odcs-contracts.result }}" == "success" ]]; then
            echo "✅ All data quality validations passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Validated Components" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Soda Core**:" >> $GITHUB_STEP_SUMMARY
            echo "- Generic data quality contracts (production patterns)" >> $GITHUB_STEP_SUMMARY
            echo "- Deterministic integration tests (baseline + 3 daily deltas)" >> $GITHUB_STEP_SUMMARY
            echo "- Referential integrity checks" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ODCS (Open Data Contract Standard)**:" >> $GITHUB_STEP_SUMMARY
            echo "- 8 data contracts validated against DuckDB" >> $GITHUB_STEP_SUMMARY
            echo "- Generic quality patterns (append-only, soft deletes)" >> $GITHUB_STEP_SUMMARY
            echo "- Documentation artifacts generated" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "❌ Some data quality validations failed. Review the logs above." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Failed Checks" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ needs.validate-soda-duckdb.result }}" != "success" ]]; then
              echo "- ❌ Soda Contracts & Scans (DuckDB)" >> $GITHUB_STEP_SUMMARY
            fi
            if [[ "${{ needs.validate-odcs-contracts.result }}" != "success" ]]; then
              echo "- ❌ ODCS Contracts (datacontract-cli)" >> $GITHUB_STEP_SUMMARY
            fi
            exit 1
          fi
