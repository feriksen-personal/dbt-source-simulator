name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint Package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install sqlfluff

      - name: Lint SQL files (when they exist)
        run: |
          if find macros -name "*.sql" -type f | grep -q .; then
            echo "Linting macro SQL files..."
            sqlfluff lint macros/ --dialect postgres || true
          else
            echo "No SQL files found yet, skipping lint"
          fi

      - name: Check YAML syntax
        run: |
          if [ -f dbt_project.yml ]; then
            python -c "import yaml; yaml.safe_load(open('dbt_project.yml'))"
            echo "✓ dbt_project.yml is valid"
          fi

  validate-structure:
    name: Validate Package Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required files
        run: |
          echo "Checking package structure..."
          test -f dbt_project.yml || (echo "Missing dbt_project.yml" && exit 1)
          test -f README.md || (echo "Missing README.md" && exit 1)
          test -f LICENSE || (echo "Missing LICENSE" && exit 1)
          test -d macros || (echo "Missing macros/ directory" && exit 1)
          test -d data || (echo "Missing data/ directory" && exit 1)
          echo "✓ All required files present"

      - name: Verify directory structure
        run: |
          # Check core directories (required)
          test -d macros/_internal || (echo "Missing macros/_internal" && exit 1)
          test -d data || (echo "Missing data/ directory" && exit 1)

          # Check optional directories (warnings only for incremental development)
          test -d data/duckdb/baseline || echo "⚠ data/duckdb/baseline not yet created"
          test -d data/duckdb/deltas || echo "⚠ data/duckdb/deltas not yet created"
          test -d data/duckdb/utilities || echo "⚠ data/duckdb/utilities not yet created"
          test -d data/azure/baseline || echo "⚠ data/azure/baseline not yet created"
          test -d data/azure/deltas || echo "⚠ data/azure/deltas not yet created"
          test -d data/azure/utilities || echo "⚠ data/azure/utilities not yet created"

          echo "✓ Core directory structure validated"

  test-duckdb:
    name: Test DuckDB Operations
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dbt-duckdb
        run: |
          python -m pip install --upgrade pip
          pip install dbt-core dbt-duckdb

      - name: Create profiles.yml
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml << 'EOF'
          demo_source:
            target: dev
            outputs:
              dev:
                type: duckdb
                path: 'demo_source.duckdb'
          EOF

      - name: Verify dbt installation
        run: |
          dbt --version

      - name: Test demo_load_baseline
        run: |
          echo "=== Testing demo_load_baseline ==="
          dbt run-operation demo_load_baseline --profile demo_source

      - name: Verify baseline data
        run: |
          echo "=== Verifying baseline data ==="
          dbt run-operation demo_verify_baseline --profile demo_source

      - name: Test demo_status
        run: |
          echo "=== Testing demo_status ==="
          dbt run-operation demo_status --profile demo_source

      # TODO: Re-enable delta tests after Issue #40 is resolved
      # Currently blocked: baseline has 5 customers, deltas reference IDs 6-125
      # - name: Test demo_apply_delta (day 1)
      #   run: |
      #     echo "=== Testing demo_apply_delta day 1 ==="
      #     dbt run-operation demo_apply_delta --args '{day: 1}' --profile demo_source
      #
      # - name: Test demo_apply_delta (day 2)
      #   run: |
      #     echo "=== Testing demo_apply_delta day 2 ==="
      #     dbt run-operation demo_apply_delta --args '{day: 2}' --profile demo_source
      #
      # - name: Test demo_apply_delta (day 3)
      #   run: |
      #     echo "=== Testing demo_apply_delta day 3 ==="
      #     dbt run-operation demo_apply_delta --args '{day: 3}' --profile demo_source

      - name: Test demo_reset
        run: |
          echo "=== Testing demo_reset ==="
          dbt run-operation demo_reset --profile demo_source

      - name: Verify reset restored baseline
        run: |
          echo "=== Verifying reset restored baseline ==="
          dbt run-operation demo_verify_baseline --profile demo_source

      - name: Final status check
        run: |
          echo "=== Final status check ==="
          dbt run-operation demo_status --profile demo_source
