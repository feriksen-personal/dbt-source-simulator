name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint Package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install sqlfluff

      - name: Lint SQL files (when they exist)
        run: |
          if find macros -name "*.sql" -type f | grep -q .; then
            echo "Linting macro SQL files..."
            sqlfluff lint macros/ --dialect postgres || true
          else
            echo "No SQL files found yet, skipping lint"
          fi

      - name: Check YAML syntax
        run: |
          if [ -f dbt_project.yml ]; then
            python -c "import yaml; yaml.safe_load(open('dbt_project.yml'))"
            echo "✓ dbt_project.yml is valid"
          fi

  validate-structure:
    name: Validate Package Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required files
        run: |
          echo "Checking package structure..."
          test -f dbt_project.yml || (echo "Missing dbt_project.yml" && exit 1)
          test -f README.md || (echo "Missing README.md" && exit 1)
          test -f LICENSE || (echo "Missing LICENSE" && exit 1)
          test -d macros || (echo "Missing macros/ directory" && exit 1)
          test -d data || (echo "Missing data/ directory" && exit 1)
          echo "✓ All required files present"

      - name: Verify directory structure
        run: |
          # Check core directories (required)
          test -d macros/_internal || (echo "Missing macros/_internal" && exit 1)
          test -d data || (echo "Missing data/ directory" && exit 1)

          # Check optional directories (warnings only for incremental development)
          test -d data/duckdb/baseline || echo "⚠ data/duckdb/baseline not yet created"
          test -d data/duckdb/deltas || echo "⚠ data/duckdb/deltas not yet created"
          test -d data/duckdb/utilities || echo "⚠ data/duckdb/utilities not yet created"
          test -d data/azure/baseline || echo "⚠ data/azure/baseline not yet created"
          test -d data/azure/deltas || echo "⚠ data/azure/deltas not yet created"
          test -d data/azure/utilities || echo "⚠ data/azure/utilities not yet created"

          echo "✓ Core directory structure validated"

  # TODO: Add functional tests once DuckDB operations are implemented
  # test-duckdb:
  #   name: Test DuckDB Operations
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.11'
  #     - name: Install dbt-duckdb
  #       run: pip install dbt-duckdb
  #     - name: Run operations
  #       run: |
  #         dbt deps
  #         dbt run-operation demo_load_baseline --target dev
  #         dbt run-operation demo_status --target dev
